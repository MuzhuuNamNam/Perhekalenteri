<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Perhekalenteri ‚Äì Firestore (vakaa versio)</title>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--border:#e5e7eb;--text:#111827;--muted:#6b7280;--primary:#2563eb;--radius:16px}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border);z-index:10}
    header .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;max-width:1100px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:8px;font-weight:600}
    .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#f3f4f6} .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:16px} @media(min-width:1024px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
    .card-title{font-weight:600} .card-content{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px}
    .textarea{min-height:80px;resize:vertical} .hint{font-size:12px;color:var(--muted)}
    .list .day{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0;border-top:1px solid var(--border)}
    .list .day:first-child{border-top:none}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;color:#fff;font-size:12px;box-shadow:0 1px 1px rgba(0,0,0,.12);border:1px solid rgba(0,0,0,.06)}
    .muted{color:var(--muted);font-size:12px}
    .month{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .weekday{font-size:12px;color:var(--muted);text-align:center}
    .cell{min-height:86px;border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff}
    .cell.off{background:#f3f4f6;color:#9ca3af}
    .cell .head{display:flex;align-items:center;justify-content:space-between;font-size:12px;margin-bottom:6px}
    .pill{padding:2px 6px;font-size:10px;color:#1d4ed8;background:#dbeafe;border-radius:999px}
    .badges{display:flex;gap:4px;flex-wrap:wrap}
    .rules{max-height:220px;overflow:auto}
    .rule{display:flex;justify-content:space-between;gap:8px;border:1px solid var(--border);border-radius:12px;padding:8px}
    .rule .colors{display:inline-flex;gap:2px;vertical-align:middle;margin-right:6px}
    .swatch{width:10px;height:10px;border-radius:999px;display:inline-block;border:1px solid rgba(0,0,0,.1)}
    .iconbtn{width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .iconbtn:hover{background:#f3f4f6}
    .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;align-items:center;justify-content:center;padding:20px}
    .dialog{background:#fff;border:1px solid var(--border);border-radius:16px;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .dialog .card-header{border-bottom:1px solid var(--border)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">üìÖ Perhekalenteri ‚Äì Firestore</div>
      <div class="actions">
        <button class="btn" id="btnToday">T√§n√§√§n</button>
        <button class="btn" id="btnThisMonth">Kuluva kuukausi</button>
        <span class="hint" id="authHint"></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <div class="card-header"><div class="card-title">Lis√§√§ merkint√§</div></div>
        <div class="card-content">
          <div class="row">
            <div class="field">
              <label>Nimi / Nimet</label>
              <select id="f_names" class="select" multiple size="6">
                <option value="Jonne">Jonne (Oranssi)</option>
                <option value="Laura">Laura (Liila)</option>
                <option value="Ella">Ella (Vaalea rosa)</option>
                <option value="Konsta">Konsta (Sininen)</option>
                <option value="Eetu">Eetu (Vihre√§)</option>
                <option value="Muu">Muu (Punainen)</option>
              </select>
              <div class="hint" style="margin-top:6px">Ctrl/‚åò + klikkaus valitsee useita.</div>
              <div id="otherWrap" class="hidden" style="margin-top:8px">
                <input id="f_other" class="input" placeholder="Kirjoita Muu-nimi (esim. 'Isovanhemmat', 'Ty√∂paikka')">
                <div class="hint" style="margin-top:6px">Muu-merkinn√§t punaisella.</div>
              </div>
            </div>
            <div class="field">
              <label>Toistettavuus</label>
              <select id="f_rec" class="select">
                <option value="once">Kertaluontainen</option>
                <option value="weekly">Viikoittain</option>
                <option value="monthly">Kuukausittain</option>
                <option value="range">Aikav√§li (voimassaolo)</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>P√§iv√§m√§√§r√§ (alku)</label>
              <input id="f_date" type="date" class="input">
            </div>
            <div class="field" id="f_range_wrap" style="display:none">
              <label>P√§iv√§m√§√§r√§ (loppu)</label>
              <input id="f_end" type="date" class="input">
            </div>
          </div>

          <div class="field" style="margin-top:12px">
            <label>Merkint√§</label>
            <textarea id="f_note" class="textarea" placeholder="Esim. Jalkapallo-ottelu klo 18 alkaen"></textarea>
          </div>

          <div class="field" style="margin-top:12px;display:flex;align-items:center;gap:8px">
            <button id="btnAdd" class="btn primary">‚ûï Lis√§√§</button>
            <span class="hint">Synkronoituu Firestoreen reaaliajassa.</span>
          </div>

          <div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px">
            <div class="muted" style="font-size:14px;margin-bottom:8px">Tallennetut s√§√§nn√∂t (<span id="ruleCount">0</span>)</div>
            <div id="rules" class="rules"></div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div class="card-title">Seuraavat ~kuukausi</div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="iconbtn" id="listBack" title="Taaksep√§in ~kuukausi">‚óÄ</button>
            <div class="muted" id="listRange" style="min-width:170px;text-align:center"></div>
            <button class="iconbtn" id="listFwd" title="Eteenp√§in ~kuukausi">‚ñ∂</button>
          </div>
        </div>
        <div class="card-content list" id="listView"></div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="card-header">
          <div class="card-title"><span id="monthTitle"></span></div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="iconbtn" id="monthBack">‚óÄ</button>
            <input type="month" id="monthPicker" class="input" style="width:auto">
            <button class="iconbtn" id="monthFwd">‚ñ∂</button>
          </div>
        </div>
        <div class="card-content">
          <div class="month" id="monthGrid"></div>
        </div>
      </section>
    </div>
  </main>

  <div class="dialog-backdrop" id="dlgBackdrop">
    <div class="dialog">
      <div class="card-header">
        <div class="card-title" id="dlgTitle"></div>
        <div class="muted" id="dlgDate"></div>
      </div>
      <div class="card-content">
        <div id="dlgNote" style="white-space:pre-wrap" class="card"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:12px">
          <button class="btn" id="dlgClose">Sulje</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {   
      apiKey: "AIzaSyBAyyY8dfRHjMdXF1VyI4hDQayRePPCsZw",
      authDomain: "perhekalenteri-6954b.firebaseapp.com",
      projectId: "perhekalenteri-6954b",
      storageBucket: "perhekalenteri-6954b.firebasestorage.app",
      messagingSenderId: "536077007093",
      appId: "1:536077007093:web:52f4e25133e986a8f06dbc",
      measurementId: "G-035S78NYJY" };

    const COLORS = {Jonne:'#f97316', Laura:'#8b5cf6', Ella:'#fbcfe8', Konsta:'#3b82f6', Eetu:'#22c55e', Muu:'#ef4444'};
    const $=sel=>document.querySelector(sel);
    const toISO = d => { const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), day=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+day; }
    const fromISO = iso => { const [y,m,d]=iso.split('-').map(Number); return new Date(y,(m||1)-1,d||1); }
    const fmt = (d, opts={}) => { const wd=['sunnuntai','maanantai','tiistai','keskiviikko','torstai','perjantai','lauantai']; const mo=['tammikuu','helmikuu','maaliskuu','huhtikuu','toukokuu','kes√§kuu','hein√§kuu','elokuu','syyskuu','lokakuu','marraskuu','joulukuu']; const day=d.getDate(),m=d.getMonth(),y=d.getFullYear(); if(opts.weekdayLong) return wd[d.getDay()]+' '+day+'.'+(m+1)+'.'+y; if(opts.monthYear) return mo[m]+' '+y; return day+'.'+(m+1)+'.'+y; }
    function addDays(d,n){ const r=new Date(d); r.setDate(r.getDate()+n); return r; }
    function addMonths(d,n){ const r=new Date(d); r.setMonth(r.getMonth()+n); return r; }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function isSameMonth(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth(); }
    function isAfter(a,b){ return +a>+b; } function isBefore(a,b){ return +a<+b; }
    function getColorFor(name){ return COLORS[name] || COLORS['Muu']; }
    function gradientFor(names){ const colors = names.map(getColorFor); if(colors.length<=1) return colors[0]||'#888'; const step=100/colors.length; const parts=colors.map((c,i)=>`${c} ${Math.round(i*step)}%, ${c} ${Math.round((i+1)*step)}%`); return `linear-gradient(90deg, ${parts.join(', ')})`; }
    function joinedLabel(names){ return names.join('+'); }

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously().then(()=>{$('#authHint').textContent='Synkronoitu ‚Äì anonyymi kirjautuminen OK'}).catch(e=>{$('#authHint').textContent='Kirjautuminen ep√§onnistui: '+e.message});

    const col = db.collection('events');
    let events=[], listAnchorISO = toISO(addDays(new Date(), -2)), monthRef = startOfMonth(new Date());

    function occursOnDate(base, dayISO){ const start=fromISO(base.startDate), day=fromISO(dayISO); if(base.recurrence!=='range' && isBefore(day,start)) return false;
      switch(base.recurrence){ case 'once': return isSameDay(start,day); case 'weekly': return start.getDay()===day.getDay() && !isBefore(day,start); case 'monthly': { const want=Math.min(start.getDate(), endOfMonth(day).getDate()); return want===day.getDate() && !isBefore(day,start); } case 'range': { const end=fromISO(base.rangeEnd||base.startDate); const s=new Date(start.getFullYear(),start.getMonth(),start.getDate()); const e=new Date(end.getFullYear(),end.getMonth(),end.getDate()); const d0=new Date(day.getFullYear(),day.getMonth(),day.getDate()); return (d0>=s && d0<=e); } } }
    function occurrencesForRange(bases, startISO, endISO){ const out=[]; let cur=fromISO(startISO); const end=fromISO(endISO); while(!isAfter(cur,end)){ const iso=toISO(cur); for(const b of bases){ if(occursOnDate(b, iso)) out.push({baseId:b.id, date:iso, names:b.names, note:b.note}); } cur=addDays(cur,1); } return out; }

    function renderRules(){ const box=$('#rules'); box.innerHTML=''; $('#ruleCount').textContent=String(events.length);
      for(const e of events){ const el=document.createElement('div'); el.className='rule'; const info=document.createElement('div');
        const dots=e.names.slice(0,5).map(n=>`<span class="swatch" title="${n}" style="background:${getColorFor(n)}"></span>`).join('');
        info.innerHTML=`<div style="font-weight:600;display:flex;align-items:center;gap:8px"><span class="colors">${dots}</span>${joinedLabel(e.names)}</div>
          <div class="muted">${fmt(fromISO(e.startDate))}${e.recurrence==='once'?' ‚Ä¢ kertaluontainen':''}${e.recurrence==='weekly'?' ‚Ä¢ viikoittain':''}${e.recurrence==='monthly'?' ‚Ä¢ kuukausittain':''}${e.recurrence==='range'?' ‚Ä¢ '+fmt(fromISO(e.startDate))+'‚Äì'+fmt(fromISO(e.rangeEnd||e.startDate)):''}</div>
          ${e.note?`<div style="margin-top:4px">${e.note}</div>`:''}`;
        const del=document.createElement('button'); del.className='iconbtn'; del.title='Poista'; del.textContent='üóë'; del.onclick=()=>col.doc(e.id).delete().catch(console.error);
        el.appendChild(info); el.appendChild(del); box.appendChild(el); } }
    function renderList(){ const listStart=fromISO(listAnchorISO), listEnd=addDays(listStart,35); $('#listRange').textContent=fmt(listStart)+' ‚Äì '+fmt(listEnd); const occ=occurrencesForRange(events,toISO(listStart),toISO(listEnd)); const box=$('#listView'); box.innerHTML='';
      for(let i=0;i<=Math.round((listEnd-listStart)/86400000);i++){ const day=addDays(listStart,i), iso=toISO(day), today=isSameDay(day,new Date()); const row=document.createElement('div'); row.className='day';
        const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
        left.innerHTML=`<div style="width:64px;text-align:right;font-weight:600">${['su','ma','ti','ke','to','pe','la'][day.getDay()]} ${day.getDate()}.${day.getMonth()+1}.</div><div class="muted" style="min-width:40px">${today?'(t√§n√§√§n)':''}</div>`;
        const right=document.createElement('div'); right.style.display='flex'; right.style.flexWrap='wrap'; right.style.gap='8px';
        const dayOcc=occ.filter(o=>o.date===iso); if(dayOcc.length===0){ const span=document.createElement('span'); span.className='muted'; span.textContent='‚Äî ei merkint√∂j√§ ‚Äî'; right.appendChild(span); }
        for(const o of dayOcc){ const b=document.createElement('button'); b.className='tag'; b.style.background=gradientFor(o.names); const light=o.names.some(n=>getColorFor(n).toLowerCase()==='#fbcfe8'); b.style.color=light && o.names.length===1 ? '#111827' : '#ffffff'; b.textContent=joinedLabel(o.names); b.onclick=()=>openDialog(o); right.appendChild(b); }
        row.appendChild(left); row.appendChild(right); box.appendChild(row); } }
    function renderMonth(){ const start=startOfMonth(monthRef), end=endOfMonth(monthRef); $('#monthTitle').textContent=fmt(start,{monthYear:true}); $('#monthPicker').value=toISO(start).slice(0,7); const grid=$('#monthGrid'); grid.innerHTML='';
      ['Ma','Ti','Ke','To','Pe','La','Su'].forEach(w=>{ const d=document.createElement('div'); d.className='weekday'; d.textContent=w; grid.appendChild(d); });
      const padStart=((start.getDay()+6)%7); const days=[]; for(let i=0;i<padStart;i++) days.push(addDays(start,-(padStart-i))); let cur=new Date(start); while(!isAfter(cur,end)){ days.push(new Date(cur)); cur=addDays(cur,1); } while(days.length%7!==0) days.push(addDays(end, days.length%7));
      const occ=occurrencesForRange(events, toISO(days[0]), toISO(days[days.length-1])); const map=occ.reduce((m,o)=>{(m[o.date]||(m[o.date]=[])).push(o); return m;},{});
      for(const d of days){ const iso=toISO(d); const cell=document.createElement('div'); cell.className='cell'+(isSameMonth(d,monthRef)?'':' off'); const head=document.createElement('div'); head.className='head'; head.innerHTML=`<span style="font-weight:600">${d.getDate()}.</span>${isSameDay(d,new Date())?'<span class="pill">t√§n√§√§n</span>':''}`;
        const badges=document.createElement('div'); badges.className='badges'; const items=(map[iso]||[]).slice(0,4); if(items.length===0){ const dash=document.createElement('span'); dash.className='muted'; dash.style.fontSize='10px'; dash.textContent='‚Äî'; badges.appendChild(dash); }
        for(const o of items){ const b=document.createElement('button'); b.className='tag'; b.style.fontSize='10px'; b.style.background=gradientFor(o.names); const light=o.names.some(n=>getColorFor(n).toLowerCase()==='#fbcfe8'); b.style.color=light && o.names.length===1 ? '#111827' : '#ffffff'; b.textContent=joinedLabel(o.names); b.title=o.note||joinedLabel(o.names); b.onclick=()=>openDialog(o); badges.appendChild(b); }
        cell.appendChild(head); cell.appendChild(badges); grid.appendChild(cell); } }
    function openDialog(o){ const colors=o.names.slice(0,5).map(n=>`<span class="swatch" title="${n}" style="background:${getColorFor(n)}"></span>`).join(''); $('#dlgTitle').innerHTML=`<span class="colors">${colors}</span>${joinedLabel(o.names)}`; $('#dlgDate').textContent=fmt(fromISO(o.date),{weekdayLong:true}); $('#dlgNote').textContent=o.note||'(ei lis√§tietoja)'; $('#dlgBackdrop').style.display='flex'; }
    function closeDialog(){ $('#dlgBackdrop').style.display='none'; } $('#dlgClose').onclick=closeDialog; $('#dlgBackdrop').onclick=(e)=>{ if(e.target.id==='dlgBackdrop') closeDialog(); };

    function selectedNames(){ const sel=document.getElementById('f_names'); const chosen=Array.from(sel.selectedOptions).map(o=>o.value); const names=chosen.filter(n=>n!=='Muu'); if(chosen.includes('Muu')){ const t=(document.getElementById('f_other').value||'').trim(); if(t) names.push(t); else names.push('Muu'); } return names; }

    document.getElementById('f_rec').addEventListener('change', e => { document.getElementById('f_range_wrap').style.display = e.target.value==='range' ? 'block' : 'none'; });
    document.getElementById('f_names').addEventListener('change', e => { const chosen = Array.from(e.target.selectedOptions).map(o=>o.value); document.getElementById('otherWrap').classList.toggle('hidden', !chosen.includes('Muu')); });
    document.getElementById('f_date').value = toISO(new Date());
    document.getElementById('btnToday').onclick=()=>{ listAnchorISO = toISO(addDays(new Date(), -2)); renderList(); };
    document.getElementById('btnThisMonth').onclick=()=>{ monthRef = startOfMonth(new Date()); renderMonth(); };
    document.getElementById('listBack').onclick=()=>{ listAnchorISO = toISO(addDays(fromISO(listAnchorISO), -36)); renderList(); };
    document.getElementById('listFwd').onclick=()=>{ listAnchorISO = toISO(addDays(fromISO(listAnchorISO), 36)); renderList(); };
    document.getElementById('monthBack').onclick=()=>{ monthRef = addMonths(monthRef, -1); renderMonth(); };
    document.getElementById('monthFwd').onclick=()=>{ monthRef = addMonths(monthRef, 1); renderMonth(); };
    document.getElementById('monthPicker').addEventListener('change', e => { const [y,m]=e.target.value.split('-').map(Number); if(y&&m) monthRef=new Date(y,m-1,1); renderMonth(); });

    col.onSnapshot(snap => { events=[]; snap.forEach(doc => { const d=doc.data()||{}; events.push({ id:doc.id, names:d.names||[], startDate:d.startDate, recurrence:d.recurrence, rangeEnd:d.rangeEnd, note:d.note||'' }); }); renderRules(); renderList(); renderMonth(); });

    document.getElementById('btnAdd').addEventListener('click', async () => {
      const names = selectedNames(); const date=$('#f_date').value; const rec=$('#f_rec').value; const rangeEnd=$('#f_end').value; const note=$('#f_note').value.trim();
      if(names.length===0){ alert('Valitse v√§hint√§√§n yksi nimi (tai Muu).'); return; } if(!date){ alert('Anna aloitusp√§iv√§.'); return; }
      const payload={ names, startDate:date, recurrence:rec, note }; if(rec==='range') payload.rangeEnd = rangeEnd || date;
      try{ const ref=await col.add(payload); await ref.update({ id: ref.id }); } catch(e){ alert('Tallennus ep√§onnistui: '+e.message); console.error(e); }
    });
  </script>
</body>
</html>
